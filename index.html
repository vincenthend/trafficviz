<html>
    <head>
    	<link rel="stylesheet" type="text/css" href="css/style.css" />
        <title>Bandung's Traffic Accidents</title>
        <script src="./js/d3.v5.min.js"></script>
				<script type="text/javascript" src="./js/rainbowvis.js"></script>
				<meta name="viewport" content= "width=device-width, initial-scale=1.0">
    </head>
		<body class="bg-viz" style="margin:0">
		<div id='locationBox'>
			<div id='locationName'></div>
			<div id="locationPersebaran">Persebaran Jenis Kecelakaan</div>
			<div id='barChart'></div>
			<div id='locationAccidents'>
				<span id='accidentsNumber'>900</span> Accidents Happened
			</div>			
			<div id='locationWounded'>
				<span id='woundedNumber'>900</span> people wounded
			</div>
			<div id='locationDead'>
				<span id='DeadNumber'>900</span> people dead
			</div>
		</div>
		<div class="slider-container">
			<div id="time-label" class="slider-label">
				All Time
			</div>
			<div id="time-clock-slot" class="slider-clock">
			</div>
			<input id="time-slider" type="range" min="-1" max="23" value="-1" step="1" class="slider" oninput="update()">
		</div>
		</body>
		
		
		<script type="text/javascript" src="./js/Chart.min.js"></script>
		<script type="text/javascript" src="./js/rainbowvis.js"></script>
		<script type="text/javascript" src="./js/chart.js"></script>
		<script type="text/javascript" src="./js/slider.js"></script>
    <script>
		load();

		//Loading Function
		function load(){
			setupMap();
			setupSlider();
			setupLocationBox();
		}

		function setupSlider(){
			d3.xml('./assets/dial.svg').then(data => {
				document.getElementById("time-clock-slot").append(data.documentElement);
				d3.select("svg#DialImage #DialObject").attr('transform','rotate(0,199,59.5)');
				
				animateDial();
			});
		}

		function setupMap(){			
			d3.xml('./assets/map.svg').then(data => {
				document.body.append(data.documentElement);
				var svg = d3.select('svg#MapImage');
				svg.attr("width","100vw")
					.attr("height","100vh");				

				// Zoom Listener
				svg.call(d3.zoom().scaleExtent([0.5,4.5])
					.on("zoom", function () {
					svg.select("#Map").transition().duration(50).attr("transform", d3.event.transform);
					})
				)
				
				// Event Listener
				var dataLine = d3.selectAll("#DataLine > *");
				dataLine.attr('pointer-events', 'visibleStroke')
					.attr('def-stroke', function() {
						return d3.select(this).attr('stroke')
					})
					.on("mouseover", function(){
						// Make it brighter
						var d = d3.select(this);
						d.transition().duration(200).attr('stroke',d3.hsl(d.attr('stroke')).brighter(0.8))
					})
					.on("mouseout", function(){
						// Make it normal
						var d = d3.select(this);
						d.transition().duration(200).attr('stroke',d.attr('def-stroke'))
					})
					.on("click",function(){
						// Respond to click on road
						var d = d3.select(this);
						var regex = /^(_*([A-z]+))*/gm;
						var m = regex.exec(d.attr('id'));
						showLocationData(m[0].split("_").join(' ').trim())
					})
			});
		}

		function setupLocationBox(){
			showLocationData("Kota Bandung");
			displayBarChart(-1);
		}

		function showLocationData(streetName){
			// TODO
			// getLocationData(streetName);
			var locationBox = d3.select('#locationBox');
			locationBox.select("#locationName").text(streetName);
			displayBarChart(-1);
			locationBox.select("#accidentsNumber").text("999");
			locationBox.select("#woundedNumber").text("1000");
			locationBox.select("#deadNumber").text("1001");
		}

		function loadJson(callback) {   
		    var xobj = new XMLHttpRequest();
		        xobj.overrideMimeType("application/json");
		    		xobj.open('GET', 'data.json', true); // Replace 'my_data' with the path to your file
		    		xobj.onreadystatechange = function () {
						if (xobj.readyState == 4 && xobj.status == "200") {
		            // Required use of an anonymous callback as .open will NOT return a value but simply returns undefined in asynchronous mode
		            callback(xobj.responseText);
						}
		    };
		    xobj.send(null);
		}
		 
	 	function getAccidentData(jsonData, startTime, callback) {
 			var dataAtCurrentTime = [];

			for(i = 0; i < jsonData.length; i++) {
				if(jsonData[i].hour == startTime || startTime == -1) {
					dataAtCurrentTime.push(jsonData[i]);
				}
			}
			callback(dataAtCurrentTime);
		 }
		 
    </script>
</html>